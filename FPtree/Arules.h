#pragma once
#include <set>
#include <map>
#include "Item.h"
#include <vector>
#include <fstream>
#include <algorithm>

using namespace std;

class Rule;

class Arules {
public:

	Arules(ifstream &_in, double _min_sup, double _min_conf) :min_sup(_min_sup), min_conf(_min_conf) {
		this->readTransactions(_in);
		//this->readFromFile(_in);
	}

	void run();

	void genFrequentPattern();

	void generateRules();

	void save(ofstream &out);

	void saveAssociation(ofstream &out);


private:

	double min_sup;//最小支持度

	double min_conf;//最小置信度

	int min_sup_count;//最小支持度计数

	map<string, int> dict;//Item从字符串表示到数字表示的映射；

	vector<set<int>> T;//所有事务的集合

	vector<map<set<int>, int>> Fk;//频繁项集的集合

	vector<Rule> rules;//所挖掘到的关联规则的集合

	void readFromFile(ifstream &in);

	void readTransactions(ifstream &in);

	void patternGrow(vector<ItemSet>& T, set<int>& suffix);


	vector<set<int>>& gen_postCondition(vector<set<int>>& Cm, vector<set<int>> &Hm);

public:
	double getMinConfidence() {
		return this->min_conf;
	}

	int getMin_sup_count() {
		return this->min_sup_count;
	}

	size_t getTransactionSize() {
		return T.size();
	}

	size_t getFrequentItemSetSize() {
		size_t size=0;
		for (int i = 0;i < Fk.size();i++) {
			size += Fk[i].size();
		}
		return size;
	}

	size_t getRulesSize() {
		return rules.size();
	}
};

class Rule {

public:

	set<int> pre;//precondition 规则前件

	set<int> post;//postcondition 规则后件

	double conf;//confidence 置信度

	double supp;//support 支持度

	double lift;//lift 提升度

	void save(ofstream &out);

	void saveAssociation(ofstream & out, map<int, string> &dictionary);

};